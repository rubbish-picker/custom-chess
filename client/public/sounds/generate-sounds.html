<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³æ•ˆç”Ÿæˆå™¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .sound-section {
            margin: 30px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .play-btn {
            background: #2196F3;
        }
        .play-btn:hover {
            background: #0b7dda;
        }
        .note {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ è±¡æ£‹éŸ³æ•ˆç”Ÿæˆå™¨</h1>
        <p style="text-align: center; color: #666;">ä½¿ç”¨ Web Audio API ç”Ÿæˆç®€å•çš„éŸ³æ•ˆ</p>
        
        <div class="sound-section">
            <h2>ğŸ¯ è½å­éŸ³æ•ˆ (Move Sound)</h2>
            <button class="play-btn" onclick="playMoveSound()">è¯•å¬</button>
            <button onclick="downloadMoveSound()">ä¸‹è½½ move.mp3</button>
            <p class="note">æ¸…è„†çš„ç‚¹å‡»å£°ï¼Œé€‚åˆæ£‹å­è½ä¸‹</p>
        </div>
        
        <div class="sound-section">
            <h2>âš ï¸ å°†å†›éŸ³æ•ˆ (Check Sound)</h2>
            <button class="play-btn" onclick="playCheckSound()">è¯•å¬</button>
            <button onclick="downloadCheckSound()">ä¸‹è½½ check.mp3</button>
            <p class="note">è­¦ç¤ºéŸ³ï¼Œé€‚åˆå°†å†›æç¤º</p>
        </div>
        
        <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 5px;">
            <h3>ğŸ“ ä½¿ç”¨è¯´æ˜ï¼š</h3>
            <ol>
                <li>ç‚¹å‡»"è¯•å¬"æŒ‰é’®å¯ä»¥é¢„è§ˆéŸ³æ•ˆ</li>
                <li>ç‚¹å‡»"ä¸‹è½½"æŒ‰é’®ä¸‹è½½éŸ³æ•ˆæ–‡ä»¶</li>
                <li>å°†ä¸‹è½½çš„æ–‡ä»¶æ”¾åˆ° <code>client/public/sounds/</code> ç›®å½•</li>
                <li>é‡å¯å¼€å‘æœåŠ¡å™¨å³å¯ä½¿ç”¨</li>
            </ol>
        </div>
    </div>

    <script>
        // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // ç”Ÿæˆè½å­éŸ³æ•ˆ
        function createMoveSound() {
            const duration = 0.1;
            const sampleRate = audioContext.sampleRate;
            const buffer = audioContext.createBuffer(1, duration * sampleRate, sampleRate);
            const data = buffer.getChannelData(0);
            
            for (let i = 0; i < buffer.length; i++) {
                const t = i / sampleRate;
                // çŸ­ä¿ƒçš„ç‚¹å‡»å£°
                data[i] = Math.sin(2 * Math.PI * 1000 * t) * Math.exp(-t * 50);
            }
            
            return buffer;
        }
        
        // ç”Ÿæˆå°†å†›éŸ³æ•ˆ
        function createCheckSound() {
            const duration = 0.3;
            const sampleRate = audioContext.sampleRate;
            const buffer = audioContext.createBuffer(1, duration * sampleRate, sampleRate);
            const data = buffer.getChannelData(0);
            
            for (let i = 0; i < buffer.length; i++) {
                const t = i / sampleRate;
                // è­¦ç¤ºéŸ³ - ä¸Šå‡éŸ³è°ƒ
                const freq = 800 + t * 400;
                data[i] = Math.sin(2 * Math.PI * freq * t) * Math.exp(-t * 8) * 0.5;
            }
            
            return buffer;
        }
        
        // æ’­æ”¾éŸ³æ•ˆ
        function playBuffer(buffer) {
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            source.start();
        }
        
        function playMoveSound() {
            playBuffer(createMoveSound());
        }
        
        function playCheckSound() {
            playBuffer(createCheckSound());
        }
        
        // ä¸‹è½½éŸ³æ•ˆ
        function downloadBuffer(buffer, filename) {
            // ä½¿ç”¨ OfflineAudioContext æ¸²æŸ“éŸ³é¢‘
            const offlineContext = new OfflineAudioContext(1, buffer.length, buffer.sampleRate);
            const source = offlineContext.createBufferSource();
            source.buffer = buffer;
            source.connect(offlineContext.destination);
            source.start();
            
            offlineContext.startRendering().then(renderedBuffer => {
                // è½¬æ¢ä¸º WAV æ ¼å¼ï¼ˆç®€åŒ–ç‰ˆï¼‰
                const wav = audioBufferToWav(renderedBuffer);
                const blob = new Blob([wav], { type: 'audio/wav' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename.replace('.mp3', '.wav'); // å®é™…æ˜¯WAVæ ¼å¼
                a.click();
                
                URL.revokeObjectURL(url);
            });
        }
        
        function downloadMoveSound() {
            downloadBuffer(createMoveSound(), 'move.mp3');
        }
        
        function downloadCheckSound() {
            downloadBuffer(createCheckSound(), 'check.mp3');
        }
        
        // å°† AudioBuffer è½¬æ¢ä¸º WAV æ ¼å¼
        function audioBufferToWav(buffer) {
            const length = buffer.length * buffer.numberOfChannels * 2 + 44;
            const arrayBuffer = new ArrayBuffer(length);
            const view = new DataView(arrayBuffer);
            const channels = [];
            let offset = 0;
            let pos = 0;
            
            // WAV æ–‡ä»¶å¤´
            setUint32(0x46464952); // "RIFF"
            setUint32(length - 8); // file length - 8
            setUint32(0x45564157); // "WAVE"
            
            setUint32(0x20746d66); // "fmt " chunk
            setUint32(16); // length = 16
            setUint16(1); // PCM (uncompressed)
            setUint16(buffer.numberOfChannels);
            setUint32(buffer.sampleRate);
            setUint32(buffer.sampleRate * 2 * buffer.numberOfChannels); // avg. bytes/sec
            setUint16(buffer.numberOfChannels * 2); // block-align
            setUint16(16); // 16-bit
            
            setUint32(0x61746164); // "data" - chunk
            setUint32(length - pos - 4); // chunk length
            
            // å†™å…¥æ ·æœ¬æ•°æ®
            for (let i = 0; i < buffer.numberOfChannels; i++) {
                channels.push(buffer.getChannelData(i));
            }
            
            while (pos < length) {
                for (let i = 0; i < buffer.numberOfChannels; i++) {
                    let sample = Math.max(-1, Math.min(1, channels[i][offset]));
                    sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
                    view.setInt16(pos, sample, true);
                    pos += 2;
                }
                offset++;
            }
            
            return arrayBuffer;
            
            function setUint16(data) {
                view.setUint16(pos, data, true);
                pos += 2;
            }
            
            function setUint32(data) {
                view.setUint32(pos, data, true);
                pos += 4;
            }
        }
    </script>
</body>
</html>
